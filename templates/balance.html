{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold"><i class="bi bi-graph-up me-1 text-primary"></i> Balance Report</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('products') }}">Products</a>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card p-3">
        <h6 class="fw-semibold">Inventory by Product</h6>
        <canvas id="balanceChart" height="140"></canvas>
        <small class="text-muted">Total quantity aggregated across locations.</small>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <h6 class="fw-semibold">Grid View</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-light"><tr><th>Product</th><th>Location</th><th class="text-end">Qty</th></tr></thead>
            <tbody>
              {% for r in rows %}
                <tr>
                  <td>{{ r.product_name }} <small class="text-muted">({{ r.product_id }})</small></td>
                  <td class="muted small">{{ r.location_name }}</td>
                  <td class="text-end fw-semibold">{{ r.qty }}</td>
                </tr>
              {% else %}
                <tr><td colspan="3" class="text-muted">No data</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block body_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // use rows provided server-side
    const rows = {{ rows|tojson }};
    const totals = {};
    rows.forEach(r => { totals[r.product_name] = (totals[r.product_name] || 0) + r.qty; });
    const labels = Object.keys(totals);
    const data = labels.map(l => totals[l]);

    const ctx = document.getElementById('balanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          borderWidth: 1,
          backgroundColor: labels.map((_,i) => `hsl(${(i*50)%360} 70% 55%)`)
        }]
      },
      options: {
        plugins: { legend: { position: 'right' } }
      }
    });
  </script>
{% endblock %}
